
### pip3 install 
pip3 install -r requirements.txt

````text
pip freeze > requirements.txt
pip install pipreqs
pipreqs .
````

### 创建运行时日志目录

mkdir runtime && mkdir session

-> ????
touch runtime/monitor.logs
touch runtime/aps.logs
touch runtime/worker.logs

### start web mode
```text
pip install gunicorn

gunicorn -w 4 -b 0.0.0.0:8091 api:app --reload

gunicorn -w 4 -b 0.0.0.0:9896 aps:app --reload
```

### is to debian 11 iptables.rules
```text
# Generated by iptables-save v1.8.0
*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -s 127.0.0.1 -d 127.0.0.1 -j ACCEPT
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p tcp --dport 8091 -j ACCEPT
-A INPUT -p tcp --dport 7981 -j ACCEPT
-A INPUT -p tcp --dport 22 -j ACCEPT
-A INPUT -p tcp --dport 8080 -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A OUTPUT -o lo -j ACCEPT
COMMIT
```

### debian 11 to start iptables
```text
chmod +x /usr/local/brain/iptables.rules

tee /etc/network/if-pre-up.d/iptables <<-'EOF'
#!/bin/sh
/sbin/iptables-restore < /usr/local/brain/iptables.rules
EOF

chmod +x /etc/network/if-pre-up.d/iptables

/sbin/iptables-restore < /usr/local/brain/iptables.rules
```

****

### nginx config
```text
upstream api {
    server 127.0.0.1:8091;
}

server {
    listen 8181;
    server_name 127.0.0.1;
    
    location / {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;
        proxy_set_header X-NginX-Proxy true;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_max_temp_file_size 0;
        proxy_pass http://api/;
        proxy_redirect off;
        proxy_read_timeout 240s;
    }    
}
```
#user ck
exec $SHELL

```text

upstream api {
    server 127.0.0.1:8091;
}

server {
  listen         80;
  server_name tg.cn381.com;
  return         301 https://$server_name$request_uri; 
}

server {
    listen 443 ssl; # managed by Certbot    
    server_name domain;
    index index.html index.htm;
    root /opt/work/web;
    
    ssl_certificate /etc/letsencrypt/live/domain/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/domain/privkey.pem; # managed by Certbot
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers off;
    ssl_ciphers "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384";
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

    client_header_buffer_size 32k;
    large_client_header_buffers 4 32k;
    location / {
		try_files $uri $uri/ /index.html;
	}

	location /v1 {
	    proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://api;
	}

	location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$
	{
		expires 30d;
	}

	location ~ .*\.(js|css)?$
	{
		expires 1h;
	}


	error_page   500 502 503 504  /50x.html;
    location = /50x.html {
         root   /usr/share/nginx/html;
    }

    access_log  /var/log/nginx/tg-access.log;
    error_log  /var/log/nginx/tg-error.log;
}
```